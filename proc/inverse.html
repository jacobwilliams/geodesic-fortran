<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Fortran implementation of geodesic routines">
    <meta name="author" content="Jacob Williams" >
    <link rel="icon" href="../favicon.png">

    <title>inverse &ndash; geodesic-fortran</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">geodesic-fortran </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="../sourcefile/geodesic_module.f90.html">Source File</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>inverse
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title="19.5% of total for procedures.">254 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/geodesic_module.F90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/geodesic_module.f90.html'>geodesic_module.F90</a></li>
                <li class="breadcrumb-item"><a href='../module/geodesic_module.html'>geodesic_module</a></li>
            <li class="breadcrumb-item active" aria-current="page">inverse</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/inverse.html#src">inverse</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine inverse(a, f, lat1, lon1, lat2, lon2, s12, azi1, azi2, outmask, a12, m12, MM12, MM21, SS12)  
</h2>
    

    <p>Solve the inverse geodesic problem.</p>
<p><code>lat1</code> and  <code>lat2</code> should be in the range [-90 deg, 90 deg].
  The values of <code>azi1</code> and <code>azi2</code> returned are in the range
  [-180 deg, 180 deg].</p>
<h2>Notes</h2>
<p>If either point is at a pole, the azimuth is defined by keeping the
  longitude fixed, writing `lat = +/- (90 deg - Epsilon),
  and taking the limit Epsilon --&gt; 0+.</p>
<p>The solution to the inverse problem is found using Newton's method.
  If this fails to converge (this is very unlikely in geodetic
  applications but does occur for very eccentric ellipsoids), then the
  bisection method is used to refine the solution.</p>


    <h3>Arguments</h3>
        <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Intent</th><th scope="col">Optional</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-a~2"></span>
              real(kind=wp),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>a</strong></td>
            <td>
                <p>the equatorial radius (meters).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-f~2"></span>
              real(kind=wp),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>f</strong></td>
            <td>
                <p>the flattening of the ellipsoid.  Setting <code>f = 0</code> gives
a sphere.  Negative <code>f</code> gives a prolate ellipsoid.</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lat1~2"></span>
              real(kind=wp),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>lat1</strong></td>
            <td>
                <p>latitude of point 1 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lon1~2"></span>
              real(kind=wp),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>lon1</strong></td>
            <td>
                <p>longitude of point 1 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lat2~2"></span>
              real(kind=wp),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>lat2</strong></td>
            <td>
                <p>latitude of point 2 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lon2~2"></span>
              real(kind=wp),
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>lon2</strong></td>
            <td>
                <p>longitude of point 2 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-s12"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>s12</strong></td>
            <td>
                <p>distance from point 1 to point 2 (meters).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-azi1~2"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>azi1</strong></td>
            <td>
                <p>azimuth at point 1 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-azi2~2"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>azi2</strong></td>
            <td>
                <p>(forward) azimuth at point 2 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-outmask~2"></span>
              integer,
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>outmask</strong></td>
            <td>
                <p>a bitor'ed combination of mask values
specifying which of the following parameters should be set.
<code>outmask</code> is an integer in [0, 16) whose binary bits are interpreted
as follows:</p>
<ul>
<li>1 return <code>a12</code></li>
<li>2 return <code>m12</code></li>
<li>4 return <code>MM12</code> and <code>MM21</code></li>
<li>8 return <code>SS12</code></li>
</ul>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-a12"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>a12</strong></td>
            <td>
                <p>arc length from point 1 to point 2 (degrees).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-m12~2"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>m12</strong></td>
            <td>
                <p>reduced length of geodesic (meters).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-mm12~2"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>MM12</strong></td>
            <td>
                <p>MM12 geodesic scale of point 2 relative to point 1 (dimensionless).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-mm21~2"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>MM21</strong></td>
            <td>
                <p>MM21 geodesic scale of point 1 relative to point 2 (dimensionless).</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ss12~2"></span>
              real(kind=wp),
            </td>
<td>intent(out)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>SS12</strong></td>
            <td>
                <p>SS12 area under the geodesic (<script type="math/tex">m^2</script>).</p>
            </td>
        </tr>
    </tbody>
  </table>

    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="k">subroutine </span><span class="n">inverse</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">lat1</span><span class="p">,</span><span class="w"> </span><span class="n">lon1</span><span class="p">,</span><span class="w"> </span><span class="n">lat2</span><span class="p">,</span><span class="w"> </span><span class="n">lon2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                   </span><span class="n">s12</span><span class="p">,</span><span class="w"> </span><span class="n">azi1</span><span class="p">,</span><span class="w"> </span><span class="n">azi2</span><span class="p">,</span><span class="w"> </span><span class="n">outmask</span><span class="p">,</span><span class="w"> </span><span class="n">a12</span><span class="p">,</span><span class="w"> </span><span class="n">m12</span><span class="p">,</span><span class="w"> </span><span class="n">MM12</span><span class="p">,</span><span class="w"> </span><span class="n">MM21</span><span class="p">,</span><span class="w"> </span><span class="n">SS12</span><span class="p">)</span>

<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="c">!! the equatorial radius (meters).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="c">!! the flattening of the ellipsoid.  Setting `f = 0` gives</span>
<span class="w">                           </span><span class="c">!! a sphere.  Negative `f` gives a prolate ellipsoid.</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">lat1</span><span class="w"> </span><span class="c">!! latitude of point 1 (degrees).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">lon1</span><span class="w"> </span><span class="c">!! longitude of point 1 (degrees).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">lat2</span><span class="w"> </span><span class="c">!! latitude of point 2 (degrees).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">lon2</span><span class="w"> </span><span class="c">!! longitude of point 2 (degrees).</span>
<span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">outmask</span><span class="w"> </span><span class="c">!! a bitor&#39;ed combination of mask values</span>
<span class="w">                               </span><span class="c">!! specifying which of the following parameters should be set.</span>
<span class="w">                               </span><span class="c">!! `outmask` is an integer in [0, 16) whose binary bits are interpreted</span>
<span class="w">                               </span><span class="c">!! as follows:</span>
<span class="w">                               </span><span class="c">!!</span>
<span class="w">                               </span><span class="c">!!  *  1 return `a12`</span>
<span class="w">                               </span><span class="c">!!  *  2 return `m12`</span>
<span class="w">                               </span><span class="c">!!  *  4 return `MM12` and `MM21`</span>
<span class="w">                               </span><span class="c">!!  *  8 return `SS12`</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">s12</span><span class="w"> </span><span class="c">!! distance from point 1 to point 2 (meters).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">azi1</span><span class="w"> </span><span class="c">!! azimuth at point 1 (degrees).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">azi2</span><span class="w"> </span><span class="c">!! (forward) azimuth at point 2 (degrees).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a12</span><span class="w"> </span><span class="c">!! arc length from point 1 to point 2 (degrees).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">m12</span><span class="w"> </span><span class="c">!! reduced length of geodesic (meters).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">MM12</span><span class="w"> </span><span class="c">!! MM12 geodesic scale of point 2 relative to point 1 (dimensionless).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">MM21</span><span class="w"> </span><span class="c">!! MM21 geodesic scale of point 1 relative to point 2 (dimensionless).</span>
<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">SS12</span><span class="w"> </span><span class="c">!! SS12 area under the geodesic (\(m^2\)).</span>

<span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span>
<span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nA3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ord</span>
<span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nA3x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nA3</span>
<span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ord</span><span class="p">,</span><span class="w"> </span><span class="n">nC3x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nC3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">nC3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nC4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ord</span><span class="p">,</span><span class="w"> </span><span class="n">nC4x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nC4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">nC4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ord</span>

<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">A3x</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nA3x</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">C3x</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nC3x</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">C4x</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nC4x</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">Ca</span><span class="p">(</span><span class="n">nC</span><span class="p">)</span>

<span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">latsign</span><span class="p">,</span><span class="w"> </span><span class="n">lonsign</span><span class="p">,</span><span class="w"> </span><span class="n">swapp</span><span class="p">,</span><span class="w"> </span><span class="n">numit</span>
<span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arcp</span><span class="p">,</span><span class="w"> </span><span class="n">redlp</span><span class="p">,</span><span class="w"> </span><span class="n">scalp</span><span class="p">,</span><span class="w"> </span><span class="n">areap</span><span class="p">,</span><span class="w"> </span><span class="n">meridian</span><span class="p">,</span><span class="w"> </span><span class="n">tripn</span><span class="p">,</span><span class="w"> </span><span class="n">tripb</span>

<span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="n">ep2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">lat1x</span><span class="p">,</span><span class="w"> </span><span class="n">lat2x</span><span class="p">,</span><span class="w"> </span><span class="n">salp0</span><span class="p">,</span><span class="w"> </span><span class="n">calp0</span><span class="p">,</span><span class="w"> </span><span class="n">k2</span><span class="p">,</span><span class="w"> </span><span class="n">eps</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp1</span><span class="p">,</span><span class="w"> </span><span class="n">ssig1</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet1</span><span class="p">,</span><span class="w"> </span><span class="n">sbet1</span><span class="p">,</span><span class="w"> </span><span class="n">dbet1</span><span class="p">,</span><span class="w"> </span><span class="n">dn1</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">salp2</span><span class="p">,</span><span class="w"> </span><span class="n">calp2</span><span class="p">,</span><span class="w"> </span><span class="n">ssig2</span><span class="p">,</span><span class="w"> </span><span class="n">csig2</span><span class="p">,</span><span class="w"> </span><span class="n">sbet2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">,</span><span class="w"> </span><span class="n">dbet2</span><span class="p">,</span><span class="w"> </span><span class="n">dn2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">slam12</span><span class="p">,</span><span class="w"> </span><span class="n">clam12</span><span class="p">,</span><span class="w"> </span><span class="n">salp12</span><span class="p">,</span><span class="w"> </span><span class="n">calp12</span><span class="p">,</span><span class="w"> </span><span class="n">omg12</span><span class="p">,</span><span class="w"> </span><span class="n">lam12</span><span class="p">,</span><span class="w"> </span><span class="n">lon12</span><span class="p">,</span><span class="w"> </span><span class="n">lon12s</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">salp1a</span><span class="p">,</span><span class="w"> </span><span class="n">calp1a</span><span class="p">,</span><span class="w"> </span><span class="n">salp1b</span><span class="p">,</span><span class="w"> </span><span class="n">calp1b</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">dalp1</span><span class="p">,</span><span class="w"> </span><span class="n">sdalp1</span><span class="p">,</span><span class="w"> </span><span class="n">cdalp1</span><span class="p">,</span><span class="w"> </span><span class="n">nsalp1</span><span class="p">,</span><span class="w"> </span><span class="n">alp12</span><span class="p">,</span><span class="w"> </span><span class="n">somg12</span><span class="p">,</span><span class="w"> </span><span class="n">comg12</span><span class="p">,</span><span class="w"> </span><span class="n">domg12</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">sig12</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">dv</span><span class="p">,</span><span class="w"> </span><span class="n">dnm</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">A4</span><span class="p">,</span><span class="w"> </span><span class="n">B41</span><span class="p">,</span><span class="w"> </span><span class="n">B42</span><span class="p">,</span><span class="w"> </span><span class="n">s12x</span><span class="p">,</span><span class="w"> </span><span class="n">m12x</span><span class="p">,</span><span class="w"> </span><span class="n">a12x</span><span class="p">,</span><span class="w"> </span><span class="n">sdomg12</span><span class="p">,</span><span class="w"> </span><span class="n">cdomg12</span>

<span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lmask</span>

<span class="n">f1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span>
<span class="n">e2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0_wp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="p">)</span>
<span class="n">ep2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f1</span><span class="o">**</span><span class="mi">2</span>
<span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mf">2.0_wp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="p">)</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">f1</span>
<span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>

<span class="n">arcp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">outmask</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="n">redlp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">outmask</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="n">scalp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">outmask</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="n">areap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">outmask</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scalp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  </span><span class="n">lmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span>
<span class="k">else</span>
<span class="k">  </span><span class="n">lmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
<span class="k">end if</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">areap</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  if</span><span class="w"> </span><span class="p">(</span><span class="n">e2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">**</span><span class="mi">2</span>
<span class="w">  </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">e2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">atanh</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">else</span>
<span class="k">    </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">atan</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e2</span><span class="p">)))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e2</span><span class="p">)))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">end if</span>
<span class="k">end if</span>

<span class="k">call </span><span class="n">A3coeff</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">A3x</span><span class="p">)</span>
<span class="k">call </span><span class="n">C3coeff</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">C3x</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">areap</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">C4coeff</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">C4x</span><span class="p">)</span>

<span class="c">! Compute longitude difference (AngDiff does this carefully).  Result is</span>
<span class="c">! in [-180, 180] but -180 is only for west-going geodesics.  180 is for</span>
<span class="c">! east-going and meridional geodesics.</span>
<span class="c">! If very close to being on the same half-meridian, then make it so.</span>
<span class="n">lon12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AngDiff</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span><span class="w"> </span><span class="n">lon2</span><span class="p">,</span><span class="w"> </span><span class="n">lon12s</span><span class="p">)</span>
<span class="c">! Make longitude difference positive.</span>
<span class="n">lonsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.0_wp</span><span class="p">,</span><span class="w"> </span><span class="n">lon12</span><span class="p">))</span>
<span class="n">lon12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lonsign</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lon12</span>
<span class="n">lon12s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lonsign</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lon12s</span>
<span class="n">lam12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">degree</span>
<span class="c">! Calculate sincos of lon12 + error (this applies AngRound internally).</span>
<span class="k">call </span><span class="n">sincosde</span><span class="p">(</span><span class="n">lon12</span><span class="p">,</span><span class="w"> </span><span class="n">lon12s</span><span class="p">,</span><span class="w"> </span><span class="n">slam12</span><span class="p">,</span><span class="w"> </span><span class="n">clam12</span><span class="p">)</span>
<span class="c">! the supplementary longitude difference</span>
<span class="n">lon12s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">180</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon12</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon12s</span>

<span class="c">! If really close to the equator, treat as on equator.</span>
<span class="n">lat1x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AngRound</span><span class="p">(</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat1</span><span class="p">))</span>
<span class="n">lat2x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AngRound</span><span class="p">(</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat2</span><span class="p">))</span>
<span class="c">! Swap points so that point with higher (abs) latitude is point 1</span>
<span class="c">! If one latitude is a nan, then it becomes lat1.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lat1x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">lat2x</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">lat2x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">lat2x</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  </span><span class="n">swapp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="k">else</span>
<span class="k">  </span><span class="n">swapp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">end if</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swapp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  </span><span class="n">lonsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">lonsign</span>
<span class="w">  </span><span class="k">call </span><span class="n">swap</span><span class="p">(</span><span class="n">lat1x</span><span class="p">,</span><span class="w"> </span><span class="n">lat2x</span><span class="p">)</span>
<span class="k">end if</span>
<span class="c">! Make lat1 &lt;= 0</span>
<span class="n">latsign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.0_wp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">lat1x</span><span class="p">))</span>
<span class="n">lat1x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat1x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latsign</span>
<span class="n">lat2x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat2x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latsign</span>
<span class="c">! Now we have</span>
<span class="c">!</span>
<span class="c">!     0 &lt;= lon12 &lt;= 180</span>
<span class="c">!     -90 &lt;= lat1 &lt;= 0</span>
<span class="c">!     lat1 &lt;= lat2 &lt;= -lat1</span>
<span class="c">!</span>
<span class="c">! longsign, swapp, latsign register the transformation to bring the</span>
<span class="c">! coordinates to this canonical form.  In all cases, 1 means no change</span>
<span class="c">! was made.  We make these transformations so that there are few cases</span>
<span class="c">! to check, e.g., on verifying quadrants in atan2.  In addition, this</span>
<span class="c">! enforces some symmetries in the results returned.</span>

<span class="k">call </span><span class="n">sincosd</span><span class="p">(</span><span class="n">lat1x</span><span class="p">,</span><span class="w"> </span><span class="n">sbet1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet1</span><span class="p">)</span>
<span class="n">sbet1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbet1</span>
<span class="k">call </span><span class="n">norm</span><span class="p">(</span><span class="n">sbet1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet1</span><span class="p">)</span>
<span class="c">! Ensure cbet1 = +dbleps at poles</span>
<span class="n">cbet1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">tiny2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet1</span><span class="p">)</span>

<span class="k">call </span><span class="n">sincosd</span><span class="p">(</span><span class="n">lat2x</span><span class="p">,</span><span class="w"> </span><span class="n">sbet2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">)</span>
<span class="n">sbet2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbet2</span>
<span class="k">call </span><span class="n">norm</span><span class="p">(</span><span class="n">sbet2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">)</span>
<span class="c">! Ensure cbet2 = +dbleps at poles</span>
<span class="n">cbet2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">tiny2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">)</span>

<span class="c">! If cbet1 &lt; -sbet1, then cbet2 - cbet1 is a sensitive measure of the</span>
<span class="c">! |bet1| - |bet2|.  Alternatively (cbet1 &gt;= -sbet1), abs(sbet2) + sbet1</span>
<span class="c">! is a better measure.  This logic is used in assigning calp2 in</span>
<span class="c">! Lambda12.  Sometimes these quantities vanish and in that case we force</span>
<span class="c">! bet2 = +/- bet1 exactly.  An example where is is necessary is the</span>
<span class="c">! inverse problem 48.522876735459 0 -48.52287673545898293</span>
<span class="c">! 179.599720456223079643 which failed with Visual Studio 10 (Release and</span>
<span class="c">! Debug)</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cbet1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">sbet1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  if</span><span class="w"> </span><span class="p">(</span><span class="n">cbet2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cbet1</span><span class="p">)</span><span class="w"> </span><span class="n">sbet2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sign</span><span class="p">(</span><span class="n">sbet1</span><span class="p">,</span><span class="w"> </span><span class="n">sbet2</span><span class="p">)</span>
<span class="k">else</span>
<span class="k">  if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sbet2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">sbet1</span><span class="p">)</span><span class="w"> </span><span class="n">cbet2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbet1</span>
<span class="k">end if</span>

<span class="n">dn1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ep2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbet1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">dn2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ep2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbet2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c">! Suppress bogus warnings about unitialized variables</span>
<span class="n">a12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">meridian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat1x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">90</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">slam12</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">meridian</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="c">! Endpoints are on a single full meridian, so the geodesic might lie on</span>
<span class="c">! a meridian.</span>

<span class="c">! Head to the target longitude</span>
<span class="w">  </span><span class="n">calp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clam12</span>
<span class="w">  </span><span class="n">salp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slam12</span>
<span class="c">! At the target we&#39;re heading north</span>
<span class="w">  </span><span class="n">calp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">salp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="c">! tan(bet) = tan(sig) * cos(alp)</span>
<span class="w">  </span><span class="n">ssig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbet1</span>
<span class="w">  </span><span class="n">csig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cbet1</span>
<span class="w">  </span><span class="n">ssig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbet2</span>
<span class="w">  </span><span class="n">csig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cbet2</span>

<span class="c">! sig12 = sig2 - sig1</span>
<span class="w">  </span><span class="n">sig12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0_wp</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ssig2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ssig1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">csig2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.0_wp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                         </span><span class="n">csig1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">csig2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ssig1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ssig2</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">Lengths</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">sig12</span><span class="p">,</span><span class="w"> </span><span class="n">ssig1</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="p">,</span><span class="w"> </span><span class="n">dn1</span><span class="p">,</span><span class="w"> </span><span class="n">ssig2</span><span class="p">,</span><span class="w"> </span><span class="n">csig2</span><span class="p">,</span><span class="w"> </span><span class="n">dn2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">cbet1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">,</span><span class="w"> </span><span class="n">lmask</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">s12x</span><span class="p">,</span><span class="w"> </span><span class="n">m12x</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="n">MM12</span><span class="p">,</span><span class="w"> </span><span class="n">MM21</span><span class="p">,</span><span class="w"> </span><span class="n">ep2</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">)</span>

<span class="c">! Add the check for sig12 since zero length geodesics might yield m12 &lt;</span>
<span class="c">! 0.  Test case was</span>
<span class="c">!</span>
<span class="c">!    echo 20.001 0 20.001 0 | GeodSolve -i</span>
<span class="c">!</span>
<span class="c">! In fact, we will have sig12 &gt; pi/2 for meridional geodesic which is</span>
<span class="c">! not a shortest path.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sig12</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">m12x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">sig12</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tiny2</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="n">sig12</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tol0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="n">s12x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">m12x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="c">! Prevent negative s12 or m12 for short lines</span>
<span class="w">      </span><span class="n">sig12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">m12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">s12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">    </span><span class="n">m12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m12x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="n">s12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s12x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="n">a12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">degree</span>
<span class="w">  </span><span class="k">else</span>
<span class="c">! m12 &lt; 0, i.e., prolate and too close to anti-podal</span>
<span class="w">    </span><span class="n">meridian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">  </span><span class="k">end if</span>
<span class="k">end if</span>

<span class="n">omg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="c">! somg12 = 2 marks that it needs to be calculated</span>
<span class="n">somg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">comg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">meridian</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">sbet1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">lon12s</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">180</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="c">! Geodesic runs along equator</span>
<span class="w">  </span><span class="n">calp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">calp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">salp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">salp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">s12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lam12</span>
<span class="w">  </span><span class="n">sig12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lam12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f1</span>
<span class="w">  </span><span class="n">omg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig12</span>
<span class="w">  </span><span class="n">m12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scalp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    </span><span class="n">MM12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
<span class="w">    </span><span class="n">MM21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MM12</span>
<span class="w">  </span><span class="k">end if</span>
<span class="k">  </span><span class="n">a12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f1</span>
<span class="k">else if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">meridian</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">! Now point1 and point2 belong within a hemisphere bounded by a</span>
<span class="c">! meridian and geodesic is neither meridional or equatorial.</span>

<span class="c">! Figure a starting point for Newton&#39;s method</span>
<span class="w">  </span><span class="n">sig12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InverseStart</span><span class="p">(</span><span class="n">sbet1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet1</span><span class="p">,</span><span class="w"> </span><span class="n">dn1</span><span class="p">,</span><span class="w"> </span><span class="n">sbet2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">,</span><span class="w"> </span><span class="n">dn2</span><span class="p">,</span><span class="w"> </span><span class="n">lam12</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="n">slam12</span><span class="p">,</span><span class="w"> </span><span class="n">clam12</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">A3x</span><span class="p">,</span><span class="w"> </span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp1</span><span class="p">,</span><span class="w"> </span><span class="n">salp2</span><span class="p">,</span><span class="w"> </span><span class="n">calp2</span><span class="p">,</span><span class="w"> </span><span class="n">dnm</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sig12</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">! Short lines (InverseStart sets salp2, calp2, dnm)</span>
<span class="w">    </span><span class="n">s12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dnm</span>
<span class="w">    </span><span class="n">m12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dnm</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">sig12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dnm</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scalp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">MM12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">sig12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dnm</span><span class="p">)</span>
<span class="w">      </span><span class="n">MM21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MM12</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">    </span><span class="n">a12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">degree</span>
<span class="w">    </span><span class="n">omg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lam12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dnm</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>

<span class="c">! Newton&#39;s method.  This is a straightforward solution of f(alp1) =</span>
<span class="c">! lambda12(alp1) - lam12 = 0 with one wrinkle.  f(alp) has exactly one</span>
<span class="c">! root in the interval (0, pi) and its derivative is positive at the</span>
<span class="c">! root.  Thus f(alp) is positive for alp &gt; alp1 and negative for alp &lt;</span>
<span class="c">! alp1.  During the course of the iteration, a range (alp1a, alp1b) is</span>
<span class="c">! maintained which brackets the root and with each evaluation of</span>
<span class="c">! f(alp) the range is shrunk, if possible.  Newton&#39;s method is</span>
<span class="c">! restarted whenever the derivative of f is negative (because the new</span>
<span class="c">! value of alp1 is then further from the solution) or if the new</span>
<span class="c">! estimate of alp1 lies outside (0,pi); in this case, the new starting</span>
<span class="c">! guess is taken to be (alp1a + alp1b) / 2.</span>

<span class="c">! Bracketing range</span>
<span class="w">    </span><span class="n">salp1a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiny2</span>
<span class="w">    </span><span class="n">calp1a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">salp1b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiny2</span>
<span class="w">    </span><span class="n">calp1b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="n">tripn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">    </span><span class="n">tripb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">    </span><span class="k">do </span><span class="n">numit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">maxit2</span><span class="o">-</span><span class="mi">1</span>
<span class="w">      </span><span class="c">! the WGS84 test set: mean = 1.47, sd = 1.25, max = 16</span>
<span class="w">      </span><span class="c">! WGS84 and random input: mean = 2.85, sd = 0.60</span>
<span class="w">      </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lambda12</span><span class="p">(</span><span class="n">sbet1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet1</span><span class="p">,</span><span class="w"> </span><span class="n">dn1</span><span class="p">,</span><span class="w"> </span><span class="n">sbet2</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">,</span><span class="w"> </span><span class="n">dn2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp1</span><span class="p">,</span><span class="w"> </span><span class="n">slam12</span><span class="p">,</span><span class="w"> </span><span class="n">clam12</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">A3x</span><span class="p">,</span><span class="w"> </span><span class="n">C3x</span><span class="p">,</span><span class="w"> </span><span class="n">salp2</span><span class="p">,</span><span class="w"> </span><span class="n">calp2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="n">sig12</span><span class="p">,</span><span class="w"> </span><span class="n">ssig1</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="p">,</span><span class="w"> </span><span class="n">ssig2</span><span class="p">,</span><span class="w"> </span><span class="n">csig2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="n">eps</span><span class="p">,</span><span class="w"> </span><span class="n">domg12</span><span class="p">,</span><span class="w"> </span><span class="n">numit</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxit1</span><span class="p">,</span><span class="w"> </span><span class="n">dv</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">)</span>
<span class="w">      </span><span class="c">! Reversed test to allow escape with NaNs</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tripn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">        </span><span class="n">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">        </span><span class="n">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">tripb</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tol0</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="w">      </span><span class="c">! Update bracketing values</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">numit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxit1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="n">calp1</span><span class="o">/</span><span class="n">salp1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">calp1b</span><span class="o">/</span><span class="n">salp1b</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">        </span><span class="n">salp1b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp1</span>
<span class="w">        </span><span class="n">calp1b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp1</span>
<span class="w">      </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">numit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxit1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">calp1</span><span class="o">/</span><span class="n">salp1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">calp1a</span><span class="o">/</span><span class="n">salp1a</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">        </span><span class="n">salp1a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp1</span>
<span class="w">        </span><span class="n">calp1a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp1</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">numit</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxit1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">dv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">        </span><span class="n">dalp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="o">/</span><span class="n">dv</span>
<span class="w">        </span><span class="n">sdalp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">dalp1</span><span class="p">)</span>
<span class="w">        </span><span class="n">cdalp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">dalp1</span><span class="p">)</span>
<span class="w">        </span><span class="n">nsalp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cdalp1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sdalp1</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nsalp1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dalp1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pi</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          </span><span class="n">calp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cdalp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">salp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sdalp1</span>
<span class="w">          </span><span class="n">salp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsalp1</span>
<span class="w">          </span><span class="k">call </span><span class="n">norm</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp1</span><span class="p">)</span>
<span class="w">          </span><span class="c">! In some regimes we don&#39;t get quadratic convergence because</span>
<span class="w">          </span><span class="c">! slope -&gt; 0.  So use convergence conditions based on dbleps</span>
<span class="w">          </span><span class="c">! instead of sqrt(dbleps).</span>
<span class="w">          </span><span class="n">tripn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tol0</span>
<span class="w">          </span><span class="k">cycle</span>
<span class="k">        end if</span>
<span class="k">      end if</span>
<span class="w">      </span><span class="c">! Either dv was not positive or updated value was outside legal</span>
<span class="w">      </span><span class="c">! range.  Use the midpoint of the bracket as the next estimate.</span>
<span class="w">      </span><span class="c">! This mechanism is not needed for the WGS84 ellipsoid, but it does</span>
<span class="w">      </span><span class="c">! catch problems with more eccentric ellipsoids.  Its efficacy is</span>
<span class="w">      </span><span class="c">! such for the WGS84 test set with the starting guess set to alp1 =</span>
<span class="w">      </span><span class="c">! 90deg:</span>
<span class="w">      </span><span class="c">! the WGS84 test set: mean = 5.21, sd = 3.93, max = 24</span>
<span class="w">      </span><span class="c">! WGS84 and random input: mean = 4.74, sd = 0.99</span>
<span class="w">      </span><span class="n">salp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">salp1a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">salp1b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="w">      </span><span class="n">calp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">calp1a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">calp1b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="w">      </span><span class="k">call </span><span class="n">norm</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp1</span><span class="p">)</span>
<span class="w">      </span><span class="n">tripn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">      </span><span class="n">tripb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">salp1a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">salp1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">calp1a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">calp1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tolb</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">          </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">salp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">salp1b</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">calp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">calp1b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tolb</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">    call </span><span class="n">Lengths</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span><span class="w"> </span><span class="n">sig12</span><span class="p">,</span><span class="w"> </span><span class="n">ssig1</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="p">,</span><span class="w"> </span><span class="n">dn1</span><span class="p">,</span><span class="w"> </span><span class="n">ssig2</span><span class="p">,</span><span class="w"> </span><span class="n">csig2</span><span class="p">,</span><span class="w"> </span><span class="n">dn2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="n">cbet1</span><span class="p">,</span><span class="w"> </span><span class="n">cbet2</span><span class="p">,</span><span class="w"> </span><span class="n">lmask</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="n">s12x</span><span class="p">,</span><span class="w"> </span><span class="n">m12x</span><span class="p">,</span><span class="w"> </span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="n">MM12</span><span class="p">,</span><span class="w"> </span><span class="n">MM21</span><span class="p">,</span><span class="w"> </span><span class="n">ep2</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">)</span>
<span class="w">    </span><span class="n">m12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m12x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="n">s12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s12x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="n">a12x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig12</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">degree</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">areap</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">sdomg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">domg12</span><span class="p">)</span>
<span class="w">      </span><span class="n">cdomg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">domg12</span><span class="p">)</span>
<span class="w">      </span><span class="n">somg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slam12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cdomg12</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">clam12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sdomg12</span>
<span class="w">      </span><span class="n">comg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clam12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cdomg12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slam12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sdomg12</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end if</span>
<span class="k">end if</span>

<span class="c">! Convert -0 to 0</span>
<span class="n">s12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s12x</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">redlp</span><span class="p">)</span><span class="w"> </span><span class="n">m12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m12x</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">areap</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">! From Lambda12: sin(alp1) * cos(bet1) = sin(alp0)</span>
<span class="w">  </span><span class="n">salp0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cbet1</span>
<span class="w">  </span><span class="n">calp0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">hypot</span><span class="p">(</span><span class="n">calp1</span><span class="p">,</span><span class="w"> </span><span class="n">salp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbet1</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calp0</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">salp0</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">! From Lambda12: tan(bet) = tan(sig) * cos(alp)</span>
<span class="w">    </span><span class="n">ssig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbet1</span>
<span class="w">    </span><span class="n">csig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cbet1</span>
<span class="w">    </span><span class="n">ssig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbet2</span>
<span class="w">    </span><span class="n">csig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cbet2</span>
<span class="w">    </span><span class="n">k2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp0</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ep2</span>
<span class="w">    </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k2</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k2</span><span class="p">)</span>
<span class="c">! Multiplier = a^2 * e^2 * cos(alpha0) * sin(alpha0).</span>
<span class="w">    </span><span class="n">A4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">calp0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">salp0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">e2</span>
<span class="w">    </span><span class="k">call </span><span class="n">norm</span><span class="p">(</span><span class="n">ssig1</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="p">)</span>
<span class="w">    </span><span class="k">call </span><span class="n">norm</span><span class="p">(</span><span class="n">ssig2</span><span class="p">,</span><span class="w"> </span><span class="n">csig2</span><span class="p">)</span>
<span class="w">    </span><span class="k">call </span><span class="n">C4f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span><span class="w"> </span><span class="n">C4x</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">)</span>
<span class="w">    </span><span class="n">B41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SinCosSeries</span><span class="p">(.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="n">ssig1</span><span class="p">,</span><span class="w"> </span><span class="n">csig1</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">,</span><span class="w"> </span><span class="n">nC4</span><span class="p">)</span>
<span class="w">    </span><span class="n">B42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SinCosSeries</span><span class="p">(.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="n">ssig2</span><span class="p">,</span><span class="w"> </span><span class="n">csig2</span><span class="p">,</span><span class="w"> </span><span class="n">Ca</span><span class="p">,</span><span class="w"> </span><span class="n">nC4</span><span class="p">)</span>
<span class="w">    </span><span class="n">SS12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">B42</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B41</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="c">! Avoid problems with indeterminate sig1, sig2 on equator</span>
<span class="w">    </span><span class="n">SS12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end if</span>

<span class="k">  if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">meridian</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">somg12</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    </span><span class="n">somg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">omg12</span><span class="p">)</span>
<span class="w">    </span><span class="n">comg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">omg12</span><span class="p">)</span>
<span class="w">  </span><span class="k">end if</span>

<span class="k">  if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">meridian</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">comg12</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.7071_wp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">sbet2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sbet1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.75_wp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">! Use tan(Gamma/2) = tan(omg12/2)</span>
<span class="c">! * (tan(bet1/2)+tan(bet2/2))/(1+tan(bet1/2)*tan(bet2/2))</span>
<span class="c">! with tan(x/2) = sin(x)/(1+cos(x))</span>
<span class="w">    </span><span class="n">domg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comg12</span>
<span class="w">    </span><span class="n">dbet1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cbet1</span>
<span class="w">    </span><span class="n">dbet2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cbet2</span>
<span class="w">    </span><span class="n">alp12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">somg12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sbet1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dbet2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sbet2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dbet1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="n">domg12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">sbet1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbet2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dbet1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dbet2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="c">! alp12 = alp2 - alp1, used in atan2 so no need to normalize</span>
<span class="w">    </span><span class="n">salp12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">calp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">salp1</span>
<span class="w">    </span><span class="n">calp12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">salp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">salp1</span>
<span class="c">! The right thing appears to happen if alp1 = +/-180 and alp2 = 0, viz</span>
<span class="c">! salp12 = -0 and alp12 = -180.  However this depends on the sign</span>
<span class="c">! being attached to 0 correctly.  The following ensures the correct</span>
<span class="c">! behavior.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">salp12</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">calp12</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">salp12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiny2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">calp1</span>
<span class="w">      </span><span class="n">calp12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">    </span><span class="n">alp12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">salp12</span><span class="p">,</span><span class="w"> </span><span class="n">calp12</span><span class="p">)</span>
<span class="w">  </span><span class="k">end if</span>
<span class="k">  </span><span class="n">SS12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SS12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">alp12</span>
<span class="w">  </span><span class="n">SS12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SS12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">swapp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lonsign</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latsign</span>
<span class="c">! Convert -0 to 0</span>
<span class="w">  </span><span class="n">SS12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SS12</span>
<span class="k">end if</span>

<span class="c">! Convert calp, salp to azimuth accounting for lonsign, swapp, latsign.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">swapp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  call </span><span class="n">swap</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">salp2</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">swap</span><span class="p">(</span><span class="n">calp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp2</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scalp</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">swap</span><span class="p">(</span><span class="n">MM12</span><span class="p">,</span><span class="w"> </span><span class="n">MM21</span><span class="p">)</span>
<span class="k">end if</span>

<span class="n">salp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">swapp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lonsign</span>
<span class="n">calp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">swapp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latsign</span>
<span class="n">salp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">salp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">swapp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lonsign</span>
<span class="n">calp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calp2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">swapp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latsign</span>

<span class="n">azi1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2d</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span><span class="w"> </span><span class="n">calp1</span><span class="p">)</span>
<span class="n">azi2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2d</span><span class="p">(</span><span class="n">salp2</span><span class="p">,</span><span class="w"> </span><span class="n">calp2</span><span class="p">)</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arcp</span><span class="p">)</span><span class="w"> </span><span class="n">a12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a12x</span>

<span class="k">end subroutine </span><span class="n">inverse</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              geodesic-fortran
 was developed by Jacob Williams<br>              &copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>